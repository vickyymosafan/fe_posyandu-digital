# Pendaftaran Lansia

Dokumentasi untuk fitur pendaftaran lansia baru.

## Arsitektur

Implementasi mengikuti prinsip SOLID dan Separation of Concerns:

### 1. Hook Layer (`useLansiaForm`)
**Tanggung Jawab:**
- Mengelola state form (data, errors, loading)
- Validasi realtime dengan Zod
- Business logic untuk submit (online/offline)
- Integrasi dengan API dan IndexedDB

**Prinsip:**
- **SRP**: Hanya handle form logic
- **DIP**: Depend on abstractions (lansiaAPI, repositories)
- **SoC**: Memisahkan business logic dari UI

### 2. Component Layer (`LansiaForm`)
**Tanggung Jawab:**
- Rendering UI form
- Menampilkan validation feedback
- Menampilkan success modal dengan ID

**Prinsip:**
- **SRP**: Hanya handle presentation
- **OCP**: Extensible dengan props
- **Composition**: Menggunakan UI components (Input, Button, Card, Modal)

### 3. Page Layer (`app/petugas/lansia/tambah/page.tsx`)
**Tanggung Jawab:**
- Layout dan routing
- Compose components

## Flow Pendaftaran

### Online Mode
1. User mengisi form
2. Validasi realtime dengan Zod
3. Generate unique ID dengan `generateIdPasien`
4. Submit ke Backend API (`POST /lansia`)
5. Save response ke IndexedDB dengan `syncedAt`
6. Tampilkan success modal dengan ID

### Offline Mode
1. User mengisi form
2. Validasi realtime dengan Zod
3. Generate unique ID dengan `generateIdPasien`
4. Save ke IndexedDB (tanpa `syncedAt`)
5. Add ke sync queue untuk sync nanti
6. Tampilkan success modal dengan ID

## Validasi

Menggunakan Zod schemas dari `lib/utils/validators.ts`:

- **NIK**: 16 digit numerik
- **KK**: 16 digit numerik
- **Nama**: Tidak boleh kosong
- **Tanggal Lahir**: Format date valid
- **Gender**: 'L' atau 'P'
- **Alamat**: Tidak boleh kosong

## Integrasi Backend

### Endpoint
```
POST /lansia
```

### Request Body
```typescript
{
  nik: string;        // 16 digit
  kk: string;         // 16 digit
  nama: string;
  tanggalLahir: string; // ISO date string
  gender: 'L' | 'P';
  alamat: string;
}
```

### Response
```typescript
{
  data: {
    id: number;
    kode: string;       // Generated by backend
    nik: string;
    kk: string;
    nama: string;
    tanggalLahir: Date;
    gender: 'L' | 'P';
    alamat: string;
    createdAt: Date;
  }
}
```

## Offline Sync

Data yang disimpan offline akan otomatis di-sync saat:
1. Browser kembali online
2. User melakukan aksi yang trigger sync
3. Periodic sync (jika diimplementasikan)

Sync dihandle oleh `SyncManager` di `lib/utils/syncManager.ts`.

## Testing

### Manual Testing Checklist

**Validasi:**
- [ ] NIK kurang dari 16 digit → error
- [ ] NIK lebih dari 16 digit → error
- [ ] NIK mengandung huruf → error
- [ ] KK kurang dari 16 digit → error
- [ ] KK lebih dari 16 digit → error
- [ ] KK mengandung huruf → error
- [ ] Nama kosong → error
- [ ] Tanggal lahir tidak dipilih → error
- [ ] Gender tidak dipilih → error
- [ ] Alamat kosong → error

**Submit Online:**
- [ ] Form valid → submit berhasil
- [ ] Tampil success modal dengan ID
- [ ] Data tersimpan di IndexedDB
- [ ] Dapat daftarkan lansia lain

**Submit Offline:**
- [ ] Disconnect network
- [ ] Form valid → submit berhasil
- [ ] Tampil success modal dengan ID
- [ ] Data tersimpan di IndexedDB
- [ ] Data masuk sync queue
- [ ] Reconnect network → data ter-sync

## Maintenance

### Menambah Field Baru

1. Update `LansiaFormData` interface di hook
2. Update `lansiaFormSchema` di validators
3. Update form UI di component
4. Update backend API contract

### Mengubah Validasi

Edit `lib/utils/validators.ts`:
```typescript
export const nikSchema = z
  .string()
  .length(16, 'NIK harus 16 digit')
  .regex(/^\d+$/, 'NIK harus berisi angka saja');
```

## Troubleshooting

### ID Generation Gagal
**Symptom:** Error "Gagal menghasilkan ID pasien unik"
**Solution:** 
- Check IndexedDB tidak penuh
- Increase `maxRetries` di `generateIdPasien`

### Submit Gagal (Online)
**Symptom:** Error dari API
**Solution:**
- Check backend running
- Check network connection
- Check API endpoint URL di `.env.local`

### Data Tidak Ter-sync
**Symptom:** Data offline tidak muncul di backend
**Solution:**
- Check sync queue di IndexedDB
- Check `SyncManager` logs di console
- Manual trigger sync dengan `syncManager.syncAll()`
